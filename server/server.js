const express = require('express');
const cors = require('cors');
const multer = require('multer');
const fetch = require('node-fetch');
const fs = require('fs');
const path = require('path');
require('dotenv').config();

const app = express();
const PORT = 3001;

// Middleware
app.use(cors());
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// Multer for handling file uploads
const upload = multer({
  limits: {
    fileSize: 5 * 1024 * 1024, // 5MB limit
  },
});

// No PDF conversion needed - Claude API supports PDF directly!

// Claude API endpoint
app.post('/api/process-payslip', async (req, res) => {
  try {
    const { base64Data, mediaType, apiKey } = req.body;
    
    const claudeApiKey = apiKey || process.env.CLAUDE_API_KEY;
    
    if (!claudeApiKey) {
      return res.status(400).json({ error: '× ×“×¨×© API Key ×©×œ Claude. ×”×•×¡×£ ×ž×¤×ª×— ××• ×”×’×“×¨ ×‘×ž×©×ª× ×” ×¡×‘×™×‘×”' });
    }

    // Claude API supports PDF directly - no conversion needed!

    const payload = {
      model: "claude-3-5-sonnet-20241022",  // Updated model with PDF support
      max_tokens: 4000,
      messages: [
        {
          role: "user",
          content: [
            {
              type: "text",
              text: `××ª×” ×ž×•×ž×—×” OCR ×ž×ª×§×“× ×”×ž×ª×ž×—×” ×‘×ª×œ×•×©×™ ×©×›×¨ ×™×©×¨××œ×™×™×. ×ª×¤×§×™×“×š ×œ×—×œ×¥ ×ž×™×“×¢ ×ž×“×•×™×§ ×ž×ª×ž×•× ×•×ª ×ª×œ×•×©×™ ×©×›×¨ ×•×œ×¡×•×•×’ ××ª ×”×”×›× ×¡×•×ª.
			  
ðŸŽ¯ MISSION: ×§×¨× ××ª ×”×ª×œ×•×© ×‘×–×”×™×¨×•×ª ×§×™×¦×•× ×™×ª ×•×—×œ×¥ ×›×œ ×ž×™×“×¢ ×¨×œ×•×•× ×˜×™

ðŸ“‹ ×ž×‘× ×” ×ª×œ×•×© ×©×›×¨ ×™×©×¨××œ×™ ×˜×™×¤×•×¡×™:
- ×¤×¨×˜×™ ×¢×•×‘×“: ×©×, ×ª.×–, ×ž×¡×¤×¨ ×¢×•×‘×“, ×—×•×“×©/×©× ×”
- ×”×›× ×¡×•×ª: ×˜×‘×œ×” ×¢× ×ª×™××•×¨, ×›×ž×•×ª, ×ª×¢×¨×™×£, ×¡×›×•×
- × ×™×›×•×™×™×: ×ž×¡ ×”×›× ×¡×”, ×‘×™×˜×•×— ×œ××•×ž×™, ×¤× ×¡×™×”
- ×¡×™×›×•×: ×‘×¨×•×˜×•, × ×™×›×•×™×™×, × ×˜×•

ðŸ” ×©×œ×‘×™ ×—×™×œ×•×¥ OCR:

×©×œ×‘ 1: ×–×™×”×•×™ ×ž×‘× ×” ×”×˜×‘×œ×” ×‘×¢×‘×¨×™×ª
**×—×©×•×‘ ×ž××•×“ - ×ž×‘× ×” ×˜×‘×œ×” ×¢×‘×¨×™×ª:**
- ×”×ª×™××•×¨ × ×ž×¦× ×‘×¢×ž×•×“×” ×”×™×ž× ×™×ª ×‘×™×•×ª×¨ (×›×™ ×¢×‘×¨×™×ª ×ž×™×ž×™×Ÿ ×œ×©×ž××œ)
- ×”×¢×ž×•×“×•×ª ×ž×©×ž××œ ×œ×™×ž×™×Ÿ ×‘×“×¨×š ×›×œ×œ: **×¡×›×•× ×¡×•×¤×™** â† ×ª×¢×¨×™×£ â† ×›×ž×•×ª â† ×ª×™××•×¨
- **×¢×ž×•×“×ª ×”×¡×›×•×ž×™× ×”×™× ×”×©×ž××œ×™×ª ×‘×™×•×ª×¨ ××• ×”×¡×ž×•×›×” ×œ×©×ž××œ**
- **×œ× ×”×¢×ž×•×“×” ×”×™×ž× ×™×ª!**

×©×œ×‘ 2: ×—×™×œ×•×¥ ×¤×¨×˜×™ ×¢×•×‘×“
- ×©× ×”×¢×•×‘×“ (×‘×“×¨×š ×›×œ×œ ×‘××–×•×¨ ×¢×œ×™×•×Ÿ)
- ×ž×¡×¤×¨ ×ª.×– (9 ×¡×¤×¨×•×ª)
- ×ž×¡×¤×¨ ×¢×•×‘×“
- ×—×•×“×© ×•×©× ×ª ×”×©×›×¨
- ×©× ×”×ž×¢×¡×™×§/×—×‘×¨×”

×©×œ×‘ 3: ×—×™×œ×•×¥ ×”×›× ×¡×•×ª - ×§×¨× ×›×œ ×©×•×¨×”!
**×–×™×”×•×™ × ×›×•×Ÿ ×©×œ ×¢×ž×•×“×•×ª:**
1. **×¢×ž×•×“×” ×™×ž× ×™×ª**: ×ª×™××•×¨ ×”×¤×¨×™×˜ (×¢×‘×¨×™×ª/×¢×¨×‘×™×ª)
2. **×¢×ž×•×“×•×ª ××ž×¦×¢**: ×›×ž×•×ª (×©×¢×•×ª/×™×—×™×“×•×ª) ×•×ª×¢×¨×™×£ (â‚ª ×œ×©×¢×”/×™×—×™×“×”)
3. **×¢×ž×•×“×” ×©×ž××œ×™×ª**: ×¡×›×•× ×›×•×œ×œ - **×–×” ×ž×” ×©×× ×—× ×• ×¨×•×¦×™×!**

âš ï¸ ×—×•×§×™ ×–×”×‘ ×œ×–×™×”×•×™ (×ž×ª×•×§×Ÿ):
1. **×”×¡×›×•× ×”×¨×œ×•×•× ×˜×™ ×”×•× ×‘×¢×ž×•×“×” ×”×©×ž××œ×™×ª, ×œ× ×”×™×ž× ×™×ª!**
2. ×¡×¤×¨×•×ª ×¢× ×ž×™× ×•×¡ (-) = × ×™×›×•×™×™× (×”×ª×¢×œ×)
3. ×¡×¤×¨×•×ª ×—×™×•×‘×™×•×ª = ×”×›× ×¡×•×ª (×—×©×•×‘!)
4. ×©×¢×•×ª ×¢×‘×•×“×” ×‘×“×¨×š ×›×œ×œ 1-200
5. ×ª×¢×¨×™×¤×™ ×©×¢×” ×‘×“×¨×š ×›×œ×œ 25-500 â‚ª
6. **×× ×™×© ×›×ž×” ×¢×ž×•×“×•×ª ×ž×¡×¤×¨×™× - ×§×— ××ª ×”×©×ž××œ×™×ª ×‘×™×•×ª×¨ ×›×¡×›×•× ×¡×•×¤×™**

ðŸ·ï¸ ×¡×™×•×•×’ ×œ×§×˜×’×•×¨×™×•×ª - **×¢×•×“×›×Ÿ ×•×—×•×“×“**:

**âš ï¸ ×›×œ×œ×™ ×¢×“×™×¤×•×ª ×œ×¡×™×•×•×’ (×ž×—×•×“×“×™× ×•×ž×—×ž×™×¨×™×):**
1. **×× ×‘×ª×™××•×¨ ×™×© ×‘×ž×“×•×™×§ "× ×¡×™×¢×•×ª" ××• ×ž×™×œ×•×ª ×ž×¤×ª×— × ×¡×™×¢×” ×ž×¤×•×¨×©×•×ª - ×–×” × ×¡×™×¢×•×ª**
2. **×× ×™×© ××—×•×–×™× ×ž×“×•×™×§×™× (125%, 150%, 175%, 200% ×•×›×•') ×‘×ª×™××•×¨ - ×–×” ×©×¢×•×ª × ×•×¡×¤×•×ª**
3. **×× ×™×© ×‘×ž×¤×•×¨×© "×©×¢×•×ª × ×•×¡×¤×•×ª" - ×–×” ×©×¢×•×ª × ×•×¡×¤×•×ª**
4. **×× ×–×” ×§×©×•×¨ ×œ×—×•×¤×©×•×ª, ×—×’×™×, ×”×‘×¨××”, ×ž×—×œ×” (×œ×œ× ××—×•×–×™×) - ×–×” "××—×¨"**
5. **×× ×–×” ×©×›×¨ ×‘×¡×™×¡ ××• ×ª×•×¡×¤×•×ª ×§×‘×•×¢×•×ª - ×–×” ×¨×’×™×œ**
6. **×‘×›×œ ×¡×¤×§ - ×”×¢×“×™×¤×•×ª ×”×™×: × ×¡×™×¢×•×ª > ×©×¢×•×ª × ×•×¡×¤×•×ª > ×¨×’×™×œ > ××—×¨**

**×§×˜×’×•×¨×™×” 1: ×¨×’×™×œ**
- "×©×›×¨ ×‘×¡×™×¡" / "×ž×©×›×•×¨×ª" / "×‘×¡×™×¡"
- "×ª×•×¡×¤×ª ×•×ª×§" / "×•×ª×§"
- "×ª×•×¡×¤×ª ×”×©×›×œ×”" / "×”×©×›×œ×”" / "×ª×•××¨"
- "×ª×•×¡×¤×ª ×ž×©×¤×—×”" / "×ž×©×¤×—×”" / "×™×œ×“×™×"
- "×ª×•×¡×¤×ª ×™×•×§×¨" / "×™×•×§×¨ ×ž×—×™×”"
- "×ª×•×¡×¤×ª ×ž×§×•×" / "×ž×§×•× ×¢×‘×•×“×”"
- **"×ª×©×œ×•×ž×™× ×‘×’×™×Ÿ ×ž×©×¨×”"** - ×–×” ×¨×’×™×œ!
- **"×©×¢×•×ª ×—×•×¤×©×”"** - ×–×” ×¨×’×™×œ!
- **"×™×ž×™ ×—×’×™×"** - ×–×” ×¨×’×™×œ!
- **"×ª×•×¡×¤×ª ×¦×‘×•×¨×”"** - ×–×” ×¨×’×™×œ!
- **"×”×‘×¨××”"** - ×–×” ×¨×’×™×œ!
- **"×ž×—×œ×”"** - ×–×” ×¨×’×™×œ!
- **"×ª×¨×•×ž×” ×¢×‘×•×¨ ×—×’"** - ×–×” ×¨×’×™×œ!
- **"×“×ž×™ ×—×’"** - ×–×” ×¨×’×™×œ!
- **"×¤×™×¦×•×™×™ ×¤×™×˜×•×¨×™×Ÿ"** - ×–×” ×¨×’×™×œ!
- **×§×˜×’×•×¨×™×” 4: ××—×¨ - ×›×œ ×ž×” ×©×œ× ×ž×ª××™× ×œ×§×˜×’×•×¨×™×•×ª ×”××—×¨×•×ª**
**âš ï¸ ×”×§×˜×’×•×¨×™×” ×©×§×•×œ×˜×ª ×”×›×™ ×”×¨×‘×” ×¤×¨×™×˜×™×:**
- **×—×•×¤×©×•×ª**: ×—×•×¤×©×”, ×©×¢×•×ª ×—×•×¤×©×”, ×™×ž×™ ×—×•×¤×©×”, ×“×ž×™ ×—×•×¤×©×”
- **×—×’×™×**: ×—×’, ×™×ž×™ ×—×’×™×, ×ª×¨×•×ž×” ×¢×‘×•×¨ ×—×’, ×“×ž×™ ×—×’
- **×”×‘×¨××”**: ×”×‘×¨××”, ×™×ž×™ ×”×‘×¨××”, ×“×ž×™ ×”×‘×¨××”  
- **×ž×—×œ×”**: ×ž×—×œ×”, ×™×ž×™ ×ž×—×œ×”, ×“×ž×™ ×ž×—×œ×”
- **×ª×•×¡×¤×•×ª ×ž×™×•×—×“×•×ª**: ×ª×•×¡×¤×ª ×œ×™×œ×”, ×ª×•×¡×¤×ª ×©×‘×ª (×©××™× ×Ÿ ×©×¢×•×ª × ×•×¡×¤×•×ª ×ž×¤×•×¨×©×•×ª)
- **×¤×™×¦×•×™×™×**: ×¤×™×¦×•×™×™ ×¤×™×˜×•×¨×™×Ÿ, ×¤×™×¦×•×™×™×
- **×‘×•× ×•×¡×™×**: ×‘×•× ×•×¡, ×ª×ž×¨×•×¥, ×”×˜×‘×•×ª
- **×›×œ ×¤×¨×™×˜ ×©×œ× × ×›× ×¡ ×‘×‘×™×¨×•×¨ ×œ×§×˜×’×•×¨×™×•×ª ×”×§×•×“×ž×•×ª**

**×¢×§×¨×•×Ÿ ×ž× ×—×” ×œ×§×˜×’×•×¨×™×™×ª "××—×¨":**
×× ×™×© ×¡×¤×§ ×œ×’×‘×™ ×¡×™×•×•×’ ×¤×¨×™×˜ - ×”×•× ×”×•×œ×š ×œ"××—×¨" ×•×œ× ×œ×©×¢×•×ª × ×•×¡×¤×•×ª ××• × ×¡×™×¢×•×ª!

**×§×˜×’×•×¨×™×” 2: ×©×¢×•×ª × ×•×¡×¤×•×ª - ×–×™×”×•×™ ×§×¤×“× ×™ ×ž××•×“**
**âš ï¸ ×¨×§ ×× ×™×© ×‘×ž×¤×•×¨×© ××ª ×”×ž×™×œ×™× ×”×ž×“×•×™×§×•×ª ×”××œ×”:**
- **"×©×¢×•×ª × ×•×¡×¤×•×ª"** (×—×•×‘×” ×©×ª×•×¤×™×¢ ×”×ž×™×œ×” ×”×–×•!)
- **×›×œ ××—×•×– ×ž×¢×œ 100%**: **"125%"** / **"150%"** / **"175%"** / **"200%"** / **"250%"** ×•×›×•'
- **"× ×•×¡×¤×•×ª"** (×¨×§ ×× ×–×” ×ž×™×œ×” × ×¤×¨×“×ª, ×œ× ×—×œ×§ ×ž×ž×™×œ×” ××—×¨×ª)
- **×›×œ ×ª×™××•×¨ ×”×ž×›×™×œ ××—×•×–×™× ×ž×“×•×™×§×™× ×›×ž×• "323 ×©×¢×•×ª 150%" ××• "327 ×©×¢×•×ª 200%"**

**ðŸš« ××¡×•×¨ ×œ×”×›× ×™×¡ ×œ×©×¢×•×ª × ×•×¡×¤×•×ª:**
- **×—×•×¤×©×”** / **×©×¢×•×ª ×—×•×¤×©×”** / **×™×ž×™ ×—×•×¤×©×”**
- **×—×’** / **×™×ž×™ ×—×’×™×** / **×ª×¨×•×ž×” ×¢×‘×•×¨ ×—×’** / **×“×ž×™ ×—×’**
- **×”×‘×¨××”** / **×™×ž×™ ×”×‘×¨××”** / **×“×ž×™ ×”×‘×¨××”**
- **×ž×—×œ×”** / **×™×ž×™ ×ž×—×œ×”** / **×“×ž×™ ×ž×—×œ×”**
- **×œ×™×œ×”** / **×ª×•×¡×¤×ª ×œ×™×œ×”** (××œ× ×× ×ž×¤×•×¨×© "×©×¢×•×ª × ×•×¡×¤×•×ª ×œ×™×œ×”")
- **×©×‘×ª** / **×ª×•×¡×¤×ª ×©×‘×ª** (××œ× ×× ×ž×¤×•×¨×© "×©×¢×•×ª × ×•×¡×¤×•×ª ×©×‘×ª")
- **×¦×‘×™×¨×”** / **×ª×•×¡×¤×ª ×¦×‘×•×¨×”**
- **×¤×™×¦×•×™×™×** / **×¤×™×¦×•×™×™ ×¤×™×˜×•×¨×™×Ÿ**
- ×›×œ ×“×‘×¨ ××—×¨ ×©××™× ×• ×ž×›×™×œ ×‘×ž×¤×•×¨×© "×©×¢×•×ª × ×•×¡×¤×•×ª" ××• ××—×•×–×™×

**×§×˜×’×•×¨×™×” 3: × ×¡×™×¢×•×ª - ×–×™×”×•×™ ×ž×“×•×™×§**
**×¨×§ ×× ×™×© ×‘×ž×¤×•×¨×© ××ª ×”×ž×™×œ×™× ×”××œ×”:**
- **"× ×¡×™×¢×•×ª"** (×”×ž×™×œ×” ×”×ž×“×•×™×§×ª ×‘×œ×‘×“!)
- **"×§×™×œ×•×ž×˜×¨××–'"** / **"×§"×ž"** / **"×§.×ž"** / **"×§×™×œ×•×ž×˜×¨×™×"**
- **"×“×ž×™ × ×¡×™×¢×”"** / **"×”×•×¦××•×ª × ×¡×™×¢×”"**
- **"×“×œ×§"** / **"×‘× ×–×™×Ÿ"** (×¨×§ ×× ×–×” ×”×—×–×¨ ×“×œ×§)
- **"×ª×—×‘×•×¨×”"** / **"×ž×•× ×™×•×ª"** (×¨×§ ×× ×–×” ×”×—×–×¨ ×ª×—×‘×•×¨×”)
- **"×”×—×–×¨ × ×¡×™×¢×•×ª"**

**ðŸš« ××¡×•×¨ ×œ×”×›× ×™×¡ ×œ× ×¡×™×¢×•×ª:**
- ×“×‘×¨×™× ×©×™×© ×‘×”× ×¨×§ ×ž×™×œ×™× ×“×•×ž×•×ª ××‘×œ ×œ× ×ž×“×•×™×§×•×ª
- ×¤×¨×™×˜×™× ×©××™×Ÿ ×‘×”× ××£ ××—×ª ×ž×”×ž×™×œ×™× ×”×ž×¤×•×¨×©×•×ª ×œ×ž×¢×œ×”
- ×ª×•×¡×¤×•×ª ×›×œ×œ×™×•×ª ×©××™× ×Ÿ ×§×©×•×¨×•×ª ×œ× ×¡×™×¢×” ×ž×ž×©

**×›×œ×œ ×ž×™×•×—×“ ×œ× ×¡×™×¢×•×ª:**
×¨×§ ×× ×”×ª×™××•×¨ ×ž×›×™×œ **×‘×ž×“×•×™×§** ××ª ×”×ž×™×œ×” "× ×¡×™×¢×•×ª" ××• ××—×ª ×ž×”×ž×™×œ×™× ×”×ž×¤×•×¨×©×•×ª - ××– ×–×” ×§×˜×’×•×¨×™×™×ª × ×¡×™×¢×•×ª

ðŸ’° ×—×™×œ×•×¥ ×¡×›×•×ž×™× (×ž×ª×•×§×Ÿ):
1. ×¢×‘×•×¨ ×¢×œ ×›×œ ×©×•×¨×” ×‘×˜×‘×œ×” ×ž×™×ž×™×Ÿ ×œ×©×ž××œ (×›×™×•×•×Ÿ ×¢×‘×¨×™×ª)
2. **×–×”×” ××ª ×”×¡×›×•× ×‘×¢×ž×•×“×” ×”×©×ž××œ×™×ª ×‘×™×•×ª×¨ (×–×” ×”×¡×›×•× ×”×¡×•×¤×™)**
3. ×× ×™×© ×›×ž×” ×¢×ž×•×“×•×ª ×ž×¡×¤×¨×™× - ×”×¡×›×•× ×”×¨×œ×•×•× ×˜×™ ×”×•× ×”×©×ž××œ×™ ×‘×™×•×ª×¨
4. ×‘×“×•×§ ×©×”×¡×›×•× ×”×’×™×•× ×™ (×œ× 0.01 ×¢×œ ×©×›×¨ ×‘×¡×™×¡)
5. ×× ×™×© ×›×ž×•×ª ×•×ª×¢×¨×™×£ ×‘××ž×¦×¢ - ×‘×“×•×§ ×©×”×›×¤×œ × ×›×•×Ÿ
6. ×¡×›×•× ×›×œ ×§×˜×’×•×¨×™×” ×‘×¡×•×£

×”×©×‘ ×‘×¤×•×¨×ž×˜ JSON ×ž×•×‘× ×”:
{
  "employeeInfo": {
    "name": "×©× ×ž×œ× ×›×¤×™ ×©×ž×•×¤×™×¢",
    "idNumber": "×ž×¡×¤×¨ ×ª.×–",
    "employeeNumber": "×ž×¡×¤×¨ ×¢×•×‘×“",
    "month": "×—×•×“×© ×©× ×”",
    "company": "×©× ×ž×¢×¡×™×§"
  },
  "categories": {
    "regular": {
      "total": ×¡×›×•×_×ž×¡×¤×¨×™,
      "items": [{"description": "×ª×™××•×¨", "amount": ×¡×›×•×, "hours": ×©×¢×•×ª_××_×™×©, "rate": ×ª×¢×¨×™×£_××_×™×©}]
    },
    "overtime": {
      "total": ×¡×›×•×_×ž×¡×¤×¨×™,
      "items": [{"description": "×ª×™××•×¨", "amount": ×¡×›×•×, "hours": ×©×¢×•×ª, "rate": "125%"}]
    },
    "travel": {
      "total": ×¡×›×•×_×ž×¡×¤×¨×™,
      "items": [{"description": "×ª×™××•×¨", "amount": ×¡×›×•×, "units": ×™×—×™×“×•×ª_××_×™×©}]
    },
    "other": {
      "total": ×¡×›×•×_×ž×¡×¤×¨×™,
      "items": [{"description": "×ª×™××•×¨", "amount": ×¡×›×•×}]
    }
  },
  "summary": {
    "totalIncome": ×¡×›×•×_×›×œ_×”×§×˜×’×•×¨×™×•×ª,
    "netSalary": ×©×›×¨_× ×˜×•_×ž×”×ª×œ×•×©,
    "grossSalary": ×©×›×¨_×‘×¨×•×˜×•_×ž×”×ª×œ×•×©
  },
  "metadata": {
    "processingNotes": "×”×¢×¨×•×ª ×¢×œ ××™×›×•×ª ×”×–×™×”×•×™",
    "confidence": "×’×‘×•×”×”/×‘×™× ×•× ×™×ª/× ×ž×•×›×”",
    "warnings": ["××–×”×¨×•×ª ×× ×™×© ×‘×¢×™×•×ª"]
  }
}

â— ×—×©×•×‘ ×ž××•×“ (×¢×•×“×›×Ÿ):
- **×”×¡×›×•× ×”×¨×œ×•×•× ×˜×™ ×ª×ž×™×“ ×‘×¢×ž×•×“×” ×”×©×ž××œ×™×ª ×‘×™×•×ª×¨!**
- **×× ×¨×•××” "× ×¡×™×¢×•×ª 1.0 268 268" - ×”-268 ×”××—×¨×•×Ÿ ×”×•× ×”×¡×›×•× ×”×¡×•×¤×™ ×•×”×•× ×”×•×œ×š ×œ×§×˜×’×•×¨×™×™×ª × ×¡×™×¢×•×ª!**
- **××œ ×ª×¡×•×•×’ ×›×©×¢×•×ª × ×•×¡×¤×•×ª ××œ× ×× ×™×© ×‘×ž×¤×•×¨×© "×©×¢×•×ª × ×•×¡×¤×•×ª" ××• ××—×•×–×™× ×ž×“×•×™×§×™×!**
- **××œ ×ª×¡×•×•×’ ×›× ×¡×™×¢×•×ª ××œ× ×× ×™×© ×‘×ž×¤×•×¨×© ×ž×™×œ×•×ª ×”×ž×¤×ª×— ×”×ž×“×•×™×§×•×ª ×œ× ×¡×™×¢×•×ª!**
- **×—×•×¤×©×”, ×—×’, ×”×‘×¨××”, ×ž×—×œ×”, ×ª×•×¡×¤×•×ª ×ž×™×•×—×“×•×ª = ×ª×ž×™×“ "××—×¨"!**
- **×‘×¡×¤×§? ×¡×“×¨ ×¢×“×™×¤×•×ª: ×¨×’×™×œ > ××—×¨ > × ×¡×™×¢×•×ª > ×©×¢×•×ª × ×•×¡×¤×•×ª**
- ××œ ×ª×ž×¦×™× ×ž×¡×¤×¨×™×!
- ×× ×œ× ×‘×˜×•×— - ×©×™× 0 ××• null
- ×ª×ž×™×“ ×‘×“×•×§ ×©×”×¡×›×•×ž×™× ×”×’×™×•× ×™×™×
- ×”×•×¡×£ ××–×”×¨×” ×× ×ž×©×”×• × ×¨××” ×œ× × ×›×•×Ÿ
- ×–×›×•×¨: ×–×” ×ž×¡×ž×š ×¤×™× × ×¡×™ ×¨×’×™×©!
- **×× ×™×© 3-4 ×¢×ž×•×“×•×ª ×ž×¡×¤×¨×™×, ×”×¡×›×•× ×”×¡×•×¤×™ ×”×•× ×”×©×ž××œ×™ ×‘×™×•×ª×¨**
- **×“×•×’×ž×”: "× ×¡×™×¢×•×ª" ×¢× ×›×ž×•×ª 1.0, ×ª×¢×¨×™×£ 268, ×¡×›×•× 268 â†’ × ×¡×™×¢×•×ª: 268 â‚ª**

â— ×—×©×•×‘ ×ž××•×“ (×ž×ª×•×§×Ÿ):
- **×”×¡×›×•× ×”×¨×œ×•×•× ×˜×™ ×ª×ž×™×“ ×‘×¢×ž×•×“×” ×”×©×ž××œ×™×ª ×‘×™×•×ª×¨!**
- **×× ×¨×•××” "× ×¡×™×¢×•×ª 1.0 268 268" - ×”-268 ×”××—×¨×•×Ÿ ×”×•× ×”×¡×›×•× ×”×¡×•×¤×™ ×•×”×•× ×”×•×œ×š ×œ×§×˜×’×•×¨×™×™×ª × ×¡×™×¢×•×ª!**
- ××œ ×ª×ž×¦×™× ×ž×¡×¤×¨×™×!
- ×× ×œ× ×‘×˜×•×— - ×©×™× 0 ××• null
- ×ª×ž×™×“ ×‘×“×•×§ ×©×”×¡×›×•×ž×™× ×”×’×™×•× ×™×™×
- ×”×•×¡×£ ××–×”×¨×” ×× ×ž×©×”×• × ×¨××” ×œ× × ×›×•×Ÿ
- ×–×›×•×¨: ×–×” ×ž×¡×ž×š ×¤×™× × ×¡×™ ×¨×’×™×©!
- **×× ×™×© 3-4 ×¢×ž×•×“×•×ª ×ž×¡×¤×¨×™×, ×”×¡×›×•× ×”×¡×•×¤×™ ×”×•× ×”×©×ž××œ×™ ×‘×™×•×ª×¨**
- **×“×•×’×ž×”: "× ×¡×™×¢×•×ª" ×¢× ×›×ž×•×ª 1.0, ×ª×¢×¨×™×£ 268, ×¡×›×•× 268 â†’ × ×¡×™×¢×•×ª: 268 â‚ª**

×¢×‘×“ ×¢×›×©×™×• ×¢×œ ×”×ž×¡×ž×š/×”×ª×ž×•× ×” ×©×œ×¤× ×™×š.`
            },
            // Support both PDF documents and images
            mediaType === 'application/pdf' ? {
              type: "document",
              source: {
                type: "base64",
                media_type: mediaType,
                data: base64Data
              }
            } : {
              type: "image",
              source: {
                type: "base64",
                media_type: mediaType,
                data: base64Data
              }
            }
          ]
        }
      ]
    };

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': claudeApiKey,
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      const errorData = await response.json();
      return res.status(response.status).json({ 
        error: `Claude API Error: ${response.status} - ${errorData.error?.message || 'Unknown error'}` 
      });
    }

    const data = await response.json();
    const responseText = data.content[0].text;
    
    // Clean response if there's extra text
    const cleanedResponse = responseText.replace(/```json|```/g, '').trim();
    
    // Extract JSON from response
    const jsonMatch = cleanedResponse.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      const result = JSON.parse(jsonMatch[0]);
      res.json(result);
    } else {
      res.status(400).json({ error: '×œ× × ×ž×¦× JSON ×ª×§×™×Ÿ ×‘×ª×’×•×‘×”' });
    }
  } catch (error) {
    console.error('×©×’×™××” ×‘×¢×™×‘×•×“:', error);
    
    if (error.message.includes('rate_limit_exceeded')) {
      res.status(429).json({ error: '×—×¨×’×ª ×ž×ž×’×‘×œ×ª ×”×‘×§×©×•×ª. × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×›×ž×” ×“×§×•×ª.' });
    } else if (error.message.includes('invalid_api_key')) {
      res.status(401).json({ error: '×ž×¤×ª×— API ×œ× ×ª×§×™×Ÿ. ×‘×“×•×§ ××ª ×”×”×’×“×¨×•×ª.' });
    } else if (error.message.includes('insufficient_quota')) {
      res.status(402).json({ error: '××™×Ÿ ×ž×¡×¤×™×§ ×™×ª×¨×” ×‘×—×©×‘×•×Ÿ Claude.' });
    } else if (error instanceof SyntaxError) {
      res.status(400).json({ error: 'Claude ×”×—×–×™×¨ ×ª×’×•×‘×” ×œ× ×ª×§×™× ×”. × ×¡×” ×©×•×‘.' });
    } else {
      res.status(500).json({ error: `×©×’×™××” ×‘×¢×™×‘×•×“ ×”×ª×ž×•× ×”: ${error.message}` });
    }
  }
});

// Health check endpoint
app.get('/api/health', (req, res) => {
  res.json({ status: 'OK', message: 'Server is running' });
});

app.listen(PORT, () => {
  console.log(`ðŸš€ Payroll server running on http://localhost:${PORT}`);
});

module.exports = app;